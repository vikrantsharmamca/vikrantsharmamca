[auto_calling]
exten => s,1,Answer()
exten => s,n,Set(phone=${to_number})
exten => s,n,NooP(${CHANNEL(accountcode)}=${client_name}=${from_number}=${to_number}=${UNIQUEID}=${CALLERID(num)}-${phone}-${campaign}-${CALLERID(dnid)}-${CALLERID(name)})
exten => s,n,Set(MONITOR_EXEC=mymix)
exten => s,n,Monitor(wav,/var/spool/asterisk/recording/${CDR(accountcode)},m)
exten => s,n,Set(CallStartTime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => s,n,Set(CURLOPT(httptimeout)=1)
exten => s,n,Set(CURLOPT(conntimeout)=1)
exten => s,n,Set(foo=${CURL(http://localhost:8011/event,botstream=answered&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${CallStartTime})})
exten => s,n,NooP(http://localhost:8011/event,botstream=answered&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${CallStartTime})
exten => s,n,NoOp(CURL-RESPONSE:${foo})
exten => s,n,Set(api_details=http://localhost:8011/event,botstream=answered&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${CallStartTime})
exten => s,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => s,n,MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => s,n,MYSQL(Disconnect ${connid})
exten => s,n,NooP(${CHANNEL(accountcode)} == ${phone1})
exten => s,n,Set(phone=${to_number})
exten => s,n,Set(campid=${CDR(accountcode)})
exten => s,n,Set(CALLERID(rdnis)=${UNIQUEID})
exten => s,n,NoOp(${crmid})
exten => s,n,NoOp(${phone})
exten => s,n,Set(CallStartTime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => s,n,Set(CALLERID(rdnis)=${UNIQUEID})
exten => s,n,Set(SIPCALLID=${DNID})
exten => s,n,NoOp(${CALLERID(all)})
exten => s,n,NoOp(${SIPCALLID})
exten => s,n,NoOp(${CALLERID(dnid)})
exten => s,n,NoOp(${CALLERID(num)})
exten => s,n,Set(CDR(userfield)=Hangupcause:${HANGUPCAUSE})
;exten => s,n,Dial(AudioSocket/172.20.1.172:8080/${CDR(accountcode)})
exten => s,n,AudioSocket(${CDR(accountcode)},localhost:8081)
exten => s,n,NoOp(${DIALSTATUS})
exten => s,n,NoOp(${HANGUPCAUSE})
exten => s,n,NoOp(${SIP_CAUSE})
exten => s,n,NoOp(${status_code})
exten => s,n,NoOp(${event_data})
exten => s,n,Hangup()

[auto_call]
exten => pre_dial_handler,1,NooP(${CHANNEL(accountcode)}=${client_name}=${from_number}=${to_number}=${CALLERID(num)}-${campaign}-${UNIQUEID}-${CALLERID(dnid)}-${CALLERID(name)})
exten => pre_dial_handler,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => pre_dial_handler,n,MYSQL(Query r ${connid} SELECT campaign,client_name,to_number FROM call_api WHERE uuid = '${CHANNEL(accountcode)}' and create_at >=curdate())
exten => pre_dial_handler,n,MYSQL(Fetch foundrow ${r} campaign_select client_name1 to_number)
exten => pre_dial_handler,n,MYSQL(Clear ${r})
exten => pre_dial_handler,n,NoOp(${campaign_select}-${client_name1}-${to_number})
exten => pre_dial_handler,n,MYSQL(Query r ${connid} UPDATE dstchannel SET dstchannel= '${CHANNEL}' WHERE uuid= '${CDR(accountcode)}' and date >= curdate())
exten => pre_dial_handler,n,MYSQL(Disconnect ${connid})
exten => pre_dial_handler,n,NoOp(${CHANNEL}== ${DSTCHANNEL})
exten => pre_dial_handler,n,Set(ringtime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => pre_dial_handler,n,Set(CURLOPT(httptimeout)=1)
exten => pre_dial_handler,n,Set(CURLOPT(conntimeout)=1)
exten => pre_dial_handler,n,Set(foo=${CURL(http://localhost:8011/event,botstream=ringing&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign_select}&timestamp=${ringtime})})
exten => pre_dial_handler,n,NooP(http://localhost:8011/event,botstream=ringing&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign_select}&timestamp=${ringtime})
exten => pre_dial_handler,n,NoOp(CURL-RESPONSE:${foo})
exten => pre_dial_handler,n,Set(api_details=http://localhost:8011/event,botstream=ringing&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign_select}&timestamp=${ringtime})
exten => pre_dial_handler,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => pre_dial_handler,n,MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name1}','${foo}'))
exten => pre_dial_handler,n,MYSQL(Disconnect ${connid})
exten => pre_dial_handler,n,Return()

exten => _X.,1,NoOp()
exten => _X.,n,Set(CURLOPT(httptimeout)=1)
exten => _X.,n,Set(CURLOPT(conntimeout)=1)
exten => _X.,n,Set(phone=${EXTEN})
exten => _X.,n,Set(CALLERID(dnid)=${EXTEN})
exten => _x.,n,Set(CALLERID(rdnis)=${UNIQUEID})
exten => _X.,n,NooP(${CHANNEL(accountcode)}=${client_name}=${from_number}=${to_number}=${CALLERID(num)}-${campaign}-${UNIQUEID}-${CALLERID(dnid)}-${CALLERID(name)})
exten => _X.,n,Set(firsttime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => _X.,n,Set(foo=${CURL(http://localhost:8011/event,botstream=started&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${firsttime})})
exten => _X.,n,NooP(http://localhost:8011/event,botstream=started&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${firsttime})
exten => _X.,n,NoOp(CURL-RESPONSE:${foo})
exten => _X.,n,Set(api_details=http://localhost:8011/event,botstream=started&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${firsttime})
exten => _X.,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => _X.,n,MYSQL(Query r ${connid} INSERT INTO dstchannel (channel, uuid) VALUES ('${CHANNEL}','${CDR(accountcode)}'))
exten => _X.,n,MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => _X.,n,MYSQL(Query r ${connid} UPDATE port_details SET current_uses=current_uses+1  WHERE client_name= '${client_name}')
exten => _X.,n,MYSQL(Disconnect ${connid})

;exten => _X.,n,SipAddHeader(P-Preferred-Identity:<sip:00918069772998@10.60.72.51>)
;exten => _X.,n,Dial(SIP/TATA_OUT/0${phone},30,b(pre_dial_handler^1)To)
;exten => _X.,n,Set(PJSIP_HEADER(add,P-Preferred-Identity)=<sip:00918069772999@10.60.72.51>)
exten => _X.,n,Set(CALLERID(num)=0091${from_number})
exten => _X.,n,Dial(PJSIP/0${phone}@tata-new,,b(pre_dial_handler^1)To)
exten => _X.,n,NoOp(${DIALSTATUS})
exten => _X.,n,NoOp(${HANGUPCAUSE})
exten => _X.,n,NoOp(${SIP_CAUSE})
exten => _X.,n,NoOp(${status_code})
exten => _X.,n,NoOp(${event_data})
exten => _X.,n,hangup()

exten => h,1,GotoIf($["${DIALSTATUS}" == "ANSWER"]?answer:others)
exten => h,n(others),GotoIf($["${DIALSTATUS}" == "CANCEL"]?CANCEL:others1)
exten => h,n(others1),GotoIf($["${DIALSTATUS}" == "NOANSWER"]?NOANSWER:others2)
exten => h,n(others2),GotoIf($["${DIALSTATUS}" == "BUSY"]?BUSY:others3)
exten => h,n(others3),GotoIf($["${DIALSTATUS}" == "CONGESTION"]?CONGESTION:others4)
exten => h,n(others4),GotoIf($["${DIALSTATUS}" == "CHANUNAVAIL"]?CHANUNAVAIL:others5)
exten => h,n(others5),GotoIf($["${DIALSTATUS}" == ""]?hangup:hangup)

exten => h,n(hangup),Set(event_data=ServiceUnavailable)
exten => h,n(hangup),Set(status_code=503)
exten => h,n(hangup),NooP(${CHANNEL(accountcode)} =${client_name}= ${UNIQUEID} =${CALLERID(num)}--${campaign}-${CALLERID(dnid)}-${CALLERID(name)})
exten => h,n(hangup),NoOp(${DIALSTATUS})
exten => h,n(hangup),NoOp(${HANGUPCAUSE})
exten => h,n(hangup),Set(endtime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => h,n(hangup),NoOp(${SIPCALLID})
exten => h,n(hangup),NooP(${CHANNEL(accountcode)} =${client_name}= ${UNIQUEID} =${CALLERID(num)}--${campaign}-${CALLERID(dnid)}-${CALLERID(name)})
exten => h,n(hangup),NoOp(${CALLERID(dnid)})
exten => h,n(hangup),Set(CURLOPT(httptimeout)=1)
exten => h,n(hangup),Set(CURLOPT(conntimeout)=1)
exten => h,n(hangup),Set(foo=${CURL(http://localhost:8011/event,botstream=hangup&event_data=${event_data}&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endtime})})
exten => h,n(hangup),NoOp(http://localhost:8011/event,botstream=hangup&event_data=${event_data}=&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endtime})
exten => h,n(hangup),NoOp(CURL-RESPONSE:${foo})
exten => h,n(hangup),Set(api_details=http://localhost:8011/event,botstream=hangup&event_data=${event_data}&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endtime})
exten => h,n(hangup),MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => h,n(hangup),MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => h,n(hangup),MYSQL(Query r ${connid} UPDATE port_details SET current_uses=(current_uses-1)  WHERE client_name='${client_name}')
exten => h,n(hangup),MYSQL(Disconnect ${connid})
exten => h,n(hangup),Hangup()

exten => h,n(answer),Set(endtime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => h,n(answer),Set(event_data=NORMAL_CLEARING)
exten => h,n(answer),Set(status_code=200)
exten => h,n(answer),NooP(${CHANNEL(accountcode)} =${client_name}= ${UNIQUEID} =${CALLERID(num)}--${campaign}-${CALLERID(dnid)}-${CALLERID(name)})
exten => h,n(answer),NoOp(${HANGUPCAUSE})
exten => h,n(answer),NoOp(${CALLERID(dnid)})
exten => h,n(answer),Set(CURLOPT(httptimeout)=1)
exten => h,n(answer),Set(CURLOPT(conntimeout)=1)
exten => h,n(answer),Set(foo=${CURL(http://localhost:8011/event,botstream=hangup&event_data=${event_data}&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${endtime})})
exten => h,n(answer),NoOp(http://localhost:8011/event,botstream=hangup&event_data=NORMAL_CLEARING&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${endtime})
exten => h,n(answer),NoOp(CURL-RESPONSE:${foo})
exten => h,n(answer),Set(api_details=http://localhost:8011/event,botstream=hangup&event_data=${event_data}&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${endtime})
exten => h,n(answer),MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => h,n(answer),MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => h,n(answer),MYSQL(Query r ${connid} UPDATE port_details SET current_uses=(current_uses-1)  WHERE client_name='${client_name}')
exten => h,n(answer),MYSQL(Disconnect ${connid})
exten => h,n(answer),NoOp(http://localhost:8011/saveToAzure,uuid=${CHANNEL(accountcode)})
exten => h,n(answer),Set(foo1=${CURL(http://localhost:8011/saveToAzure,uuid=${CHANNEL(accountcode)})})
exten => h,n(answer),NoOp(CURL-RESPONSE:${foo1})
exten => h,n(answer),Hangup()



exten => h,n(CANCEL),Set(event_data=CANCEL)
exten => h,n(CANCEL),Set(status_code=403)
exten => h,n(CANCEL),Set(endcall=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => h,n(CANCEL),Set(CURLOPT(httptimeout)=1)
exten => h,n(CANCEL),Set(CURLOPT(conntimeout)=1)
exten => h,n(CANCEL),Set(foo=${CURL(http://localhost:8011/event,botstream=hangup&event_data=CANCEL&status_code=403&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})})
exten => h,n(CANCEL),NooP(http://localhost:8011/event,botstream=hangup&event_data=CANCEL&status_code=403&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})
exten => h,n(CANCEL),NoOp(CURL-RESPONSE:${foo})
exten => h,n(CANCEL),Set(api_details=http://localhost:8011/event,botstream=hangup&event_data=CANCEL&status_code=403&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})
exten => h,n(CANCEL),MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => h,n(CANCEL),MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => h,n(CANCEL),MYSQL(Query r ${connid} UPDATE port_details SET current_uses=(current_uses-1)  WHERE client_name= '${client_name}')
exten => h,n(CANCEL),MYSQL(Disconnect ${connid})
exten => h,n(CANCEL),Hangup()


exten => h,n(CONGESTION),Set(event_data=CONGESTION)
exten => h,n(CONGESTION),Set(status_code=404)
exten => h,n(CONGESTION),Set(endcall=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => h,n(CONGESTION),Set(CURLOPT(httptimeout)=1)
exten => h,n(CONGESTION),Set(CURLOPT(conntimeout)=1)
exten => h,n(CONGESTION),Set(foo=${CURL(http://localhost:8011/event,botstream=hangup&event_data=CANCEL&status_code=403&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})})
exten => h,n(CONGESTION),NooP(http://localhost:8011/event,botstream=hangup&event_data=CANCEL&status_code=403&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})
exten => h,n(CONGESTION),NoOp(CURL-RESPONSE:${foo})
exten => h,n(CONGESTION),Set(api_details=http://localhost:8011/event,botstream=hangup&event_data=CANCEL&status_code=403&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})
exten => h,n(CONGESTION),MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => h,n(CONGESTION),MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => h,n(CONGESTION),MYSQL(Query r ${connid} UPDATE port_details SET current_uses=(current_uses-1)  WHERE client_name= '${client_name}')
exten => h,n(CONGESTION),MYSQL(Disconnect ${connid})
exten => h,n(CONGESTION),Hangup()


exten => h,n(CHANUNAVAIL),Set(event_data=CHANUNAVAIL)
exten => h,n(CHANUNAVAIL),Set(status_code=404)
exten => h,n(CHANUNAVAIL),Set(endcall=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => h,n(CHANUNAVAIL),Set(CURLOPT(httptimeout)=1)
exten => h,n(CHANUNAVAIL),Set(CURLOPT(conntimeout)=1)
exten => h,n(CHANUNAVAIL),Set(foo=${CURL(http://localhost:8011/event,botstream=hangup&event_data=CANCEL&status_code=403&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})})
exten => h,n(CHANUNAVAIL),NooP(http://localhost:8011/event,botstream=hangup&event_data=CANCEL&status_code=403&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})
exten => h,n(CHANUNAVAIL),NoOp(CURL-RESPONSE:${foo})
exten => h,n(CHANUNAVAIL),Set(api_details=http://localhost:8011/event,botstream=hangup&event_data=CANCEL&status_code=403&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})
exten => h,n(CHANUNAVAIL),MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => h,n(CHANUNAVAIL),MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => h,n(CHANUNAVAIL),MYSQL(Query r ${connid} UPDATE port_details SET current_uses=(current_uses-1)  WHERE client_name= '${client_name}')
exten => h,n(CHANUNAVAIL),MYSQL(Disconnect ${connid})
exten => h,n(CHANUNAVAIL),Hangup()


exten => h,n(NOANSWER),Set(event_data=NOANSWER)
exten => h,n(NOANSWER),Set(status_code=480)
exten => h,n(NOANSWER),Set(endcall=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => h,n(NOANSWER),Set(CURLOPT(httptimeout)=1)
exten => h,n(NOANSWER),Set(CURLOPT(conntimeout)=1)
exten => h,n(NOANSWER),Set(foo=${CURL(http://localhost:8011/event,botstream=hangup&event_data=NOANSWER&status_code=480&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})})
exten => h,n(NOANSWER),NooP(http://localhost:8011/event,botstream=hangup&event_data=NOANSWER&status_code=480&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})
exten => h,n(NOANSWER),NoOp(CURL-RESPONSE:${foo})
exten => h,n(NOANSWER),Set(api_details=http://localhost:8011/event,botstream=hangup&event_data=NOANSWER&status_code=480&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})
exten => h,n(NOANSWER),MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => h,n(NOANSWER),MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => h,n(NOANSWER),MYSQL(Query r ${connid} UPDATE port_details SET current_uses=(current_uses-1)  WHERE client_name= '${client_name}')
exten => h,n(NOANSWER),MYSQL(Disconnect ${connid})
exten => h,n(NOANSWER),Hangup()


exten => h,n(BUSY),Set(event_data=BUSY)
exten => h,n(BUSY),Set(status_code=486)
exten => h,n(BUSY),Set(endcall=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => h,n(BUSY),Set(CURLOPT(httptimeout)=1)
exten => h,n(BUSY),Set(CURLOPT(conntimeout)=1)
exten => h,n(BUSY),Set(foo=${CURL(http://localhost:8011/event,botstream=hangup&event_data=NOANSWER&status_code=480&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})})
exten => h,n(BUSY),NooP(http://localhost:8011/event,botstream=hangup&event_data=NOANSWER&status_code=480&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})
exten => h,n(BUSY),NoOp(CURL-RESPONSE:${foo})
exten => h,n(BUSY),Set(api_details=http://localhost:8011/event,botstream=hangup&event_data=NOANSWER&status_code=480&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${endcall})
exten => h,n(BUSY),MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => h,n(BUSY),MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => h,n(BUSY),MYSQL(Query r ${connid} UPDATE port_details SET current_uses=(current_uses-1)  WHERE client_name= '${client_name}')
exten => h,n(BUSY),MYSQL(Disconnect ${connid})
exten => h,n(BUSY),Hangup()






