[from-internal]
exten => 1234,1,Ringing(5)
exten => 1234,n,agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"Welcome to ASR taining module",en)
exten => 1234,n,NoOp(${CALLERID(num)})
exten => 1234,n,NoOp(${CALLERID(name)})
exten => 1234,n,Set(phone=${CALLERID(num):-10})
exten => 1234,n,NoOp(${phone})
exten => 1234,n,Set(CALLERID(rdnis)=${UNIQUEID})
exten => 1234,n,NoOp(${UNIQUEID})
exten => 1234,n,NoOp(${CALLERID(rdnis)})
exten => 1234,n,NoOp(${EXTEN})
exten => 1234,n,NooP(${CDR(accountcode)})
exten => 1234,n,NooP(${CDR(channel)})
exten => 1234,n,NooP(${CDR(dstchannel)})
exten => 1234,n,NooP(${ENV(VAR)})
exten => 1234,n,NooP(${ENV(variable1)})
exten => 1234,n,NooP(${variable1})
exten => 1234,n,NooP(${variable2})
exten => 1234,n,NooP(${message})
exten => 1234,n,NooP(${digits})
exten => 1234,n,NooP(${dest})
exten => 1234,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => 1234,n,MYSQL(Query r ${connid} INSERT into training_module(phone,uniqueid) VALUES ('${phone}','${UNIQUEID}'))
exten => 1234,n,MYSQL(Disconnect ${connid})
exten => 1234,n,Read(sheetid,/var/lib/asterisk/sounds/recording/sheetid_enter,10,,2,10)
exten => 1234,n,Gotoif($["${sheetid}" = ""]?empty:input)
exten => 1234,n(empty),agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"Wait time is exceeded thanks for calling",en)
exten => 1234,n(empty),Hangup()

same => n(input),Set(CHANNEL(accountcode)=${sheetid})
same => n(input),goto(extention,${sheetid},1)

[extention]
exten => _.,1,agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"Entered sheet number is",en)
exten => _.,n,SayDigits(${CHANNEL(accountcode)})
exten => _.,n,Background(/var/lib/asterisk/sounds/recording/presshash_startconf)
exten => _.,n,WaitExten(4)
exten => _.,n,Background(/var/lib/asterisk/sounds/recording/presshash_startconf)
exten => _.,n,WaitExten(4)
exten => _.,n,agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"Wait time is exceeded thanks for calling",en)
exten => _.,n,Hangup()

exten => #,1,Set(sheetid=)
exten => #,n,goto(from-internal,1234,1)

exten => *,1,Set(UtteranceID=)
exten => *,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => *,n,MYSQL(Query r ${connid} UPDATE training_module SET sheet_id= '${CHANNEL(accountcode)}' WHERE uniqueid = '${CALLERID(rdnis)}')
exten => *,n,MYSQL(Disconnect ${connid})
exten => *,n,goto(Utterance,${CHANNEL(accountcode)},1)

[Utterance]
exten => _.,1,Read(UtteranceID,/var/lib/asterisk/sounds/recording/UtteranceID_fallowedbyHash_key,10,,2,10)
exten => _.,n,Set(ENV(VAR)=${UtteranceID})
exten => _.,n,Gotoif($["${UtteranceID}" = ""]?empty:input)

exten => _.,n(empty),agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"Empaty number is reccived please try again",en)
exten => _.,n(empty),goto(Utterance,${CHANNEL(accountcode)},1)
exten => _.,n(empty),Hangup()

exten => _.,n(input),Playback(you-entered)
exten => _.,n(input),SayDigits(${ENV(VAR)})
exten => _.,n(input),Background(/var/lib/asterisk/sounds/recording/presshash_startconf)
exten => _.,n(input),WaitExten(4)
exten => _.,n(input),Background(/var/lib/asterisk/sounds/recording/presshash_startconf)
exten => _.,n(input),WaitExten(4)
exten => _.,n(input),agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"wait time is exceeded",en)
exten => _.,n(input),Hangup()

exten => *,1,goto(enter,${ENV(VAR)},1) 
exten => #,1,Set(UtteranceID=)
exten => #,n,Set(ENV(VAR)=)
exten => #,n,goto(Utterance,${CHANNEL(accountcode)},1)


[enter]
exten => _.,1,agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"Please Record your audio message after the peep and press hash to end the audio",en)
exten => _.,n,Set(Recording=${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)})
exten => _.,n,Record(/home/Recording/training/final/${Recording}_${CHANNEL(accountcode)}_${ENV(VAR)}_${phone}.wav,0,30,#)
exten => _.,n,agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"Your recorded message is ",en)
exten => _.,n,Playback(/home/Recording/training/final/${Recording}_${CHANNEL(accountcode)}_${ENV(VAR)}_${phone})
exten => _.,n,Background(/var/lib/asterisk/sounds/recording/next_utterences)
exten => _.,n,WaitExten(5)
exten => _.,n,Background(/var/lib/asterisk/sounds/recording/next_utterences)
exten => _.,n,WaitExten(5)
exten => _.,n,agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"wait time is exceeded",en)
exten => _.,n,System(/bin/rm -rf /var/www/Recording/training/final/${Recording}_${CHANNEL(accountcode)}_${ENV(VAR)}_${phone}.wav)
exten => _.,n,Hangup()

exten => #,1,System(/bin/rm -rf /var/www/Recording/training/final/${CHANNEL(accountcode)}_${ENV(VAR)}_${phone}_${Recording}.wav) ;repeat
exten => #,n,goto(enter,${ENV(VAR)},1) ;repeat #

exten => *,1,Set(foo=${CURL(http://localhost:8011/saveStereoToAzure,audio=${Recording}_${CHANNEL(accountcode)}_${ENV(VAR)}_${phone})})
exten => *,n,NooP(http://localhost:8011/saveStereoToAzure,audio=${Recording}_${CHANNEL(accountcode)}_${ENV(VAR)}_${phone})
exten => *,n,NoOp(CURL-RESPONSE:${foo})
exten => *,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => *,n,MYSQL(Query r ${connid} INSERT INTO taining_recording(sheet_id,Utterance_id,uniqueid,recording_name,response) VALUES ('${CHANNEL(accountcode)}','${ENV(VAR)}','${CALLERID(rdnis)}','${CHANNEL(accountcode)}_${ENV(VAR)}_${phone}_${Recording}','${foo}'))
exten => *,n,MYSQL(Disconnect ${connid})
exten => *,n,Set(UtteranceID=) ;* save
exten => *,n,goto(next,next,1) ;* save

exten => h,1,NooP(******************************************************)
exten => h,n,Set(foo=${CURL(http://localhost:8011/saveStereoToAzure,audio=${Recording}_${CHANNEL(accountcode)}_${ENV(VAR)}_${phone})})
exten => h,n,NooP(http://localhost:8011/saveStereoToAzure,audio=${Recording}_${CHANNEL(accountcode)}_${ENV(VAR)}_${phone}))
exten => h,n,NoOp(CURL-RESPONSE:${foo})
exten => h,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => h,n,MYSQL(Query r ${connid} INSERT INTO taining_recording(sheet_id,Utterance_id,uniqueid,recording_name,response) VALUES ('${CHANNEL(accountcode)}','${ENV(VAR)}','${CALLERID(rdnis)}','${CHANNEL(accountcode)}_${ENV(VAR)}_${phone}_${Recording}','${foo}'))
exten => h,n,MYSQL(Disconnect ${connid})
exten => h,n,Hangup()

[next]
exten => next,1,Read(UtteranceID,/var/lib/asterisk/sounds/recording/UtteranceID_fallowedbyHash_key,10,,2,10)
exten => next,n,Set(ENV(VAR)=${UtteranceID})
exten => next,n,Gotoif($["${UtteranceID}" == ""]?empty:input)
exten => next,n,NooP(${ENV(VAR)})
exten => next,n(empty),agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"Empaty number is reccived please try again",en)
exten => next,n(empty),goto(next,next,1)
exten => next,n(input),Playback(you-entered)
exten => next,n(input),SayDigits(${ENV(VAR)})
exten => next,n(input),Background(/var/lib/asterisk/sounds/recording/presshash_startconf)
exten => next,n(input),WaitExten(5)
exten => next,n(input),Background(/var/lib/asterisk/sounds/recording/presshash_startconf)
exten => next,n(input),WaitExten(5)
exten => next,n(input),agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"wait time is exceeded",en)
exten => next,n(input),Hangup()
exten => #,1,goto(next,next,1)
exten => *,1,goto(enter,${ENV(VAR)},1)