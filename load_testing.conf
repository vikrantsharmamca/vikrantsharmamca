[test_calling]
exten => s,1,Answer()
exten => s,n,MixMonitor(/home/Recording/${CHANNEL(accountcode)}.wav)
exten => s,n,Set(event_data=NORMAL_CLEARING)
exten => s,n,Set(status_code=200)
exten => s,n,NooP(${CHANNEL(accountcode)}=${client_name}=${from_number}=${to_number}=${CALLERID(num)}-${campaign}-${UNIQUEID}-${CALLERID(dnid)}-${CALLERID(name)}=${phone})
exten => s,n,Set(MONITOR_EXEC=mymix)
exten => s,n,Monitor(wav,/var/spool/asterisk/recording/${CDR(accountcode)},m)
exten => s,n,Set(CallStartTime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => s,n,Set(CURLOPT(httptimeout)=1)
exten => s,n,Set(CURLOPT(conntimeout)=1)
exten => s,n,Set(foo=${CURL(http://localhost:8011/event,botstream=answered&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${CallStartTime})})
exten => s,n,NooP(http://localhost:8011/event,botstream=answered&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${CallStartTime})
exten => s,n,NoOp(CURL-RESPONSE:${foo})
exten => s,n,Set(api_details=http://localhost:8011/event,botstream=answered&uuid=${CHANNEL(accountcode)}&phone=${to_number}&campaign=${campaign}&timestamp=${CallStartTime})
exten => s,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => s,n,MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => s,n,MYSQL(Disconnect ${connid})
exten => s,n,Set(phone=${to_number})
exten => s,n,Set(CDR(userfield)=Hangupcause:${HANGUPCAUSE})
;exten => s,n,Dial(AudioSocket/172.20.1.172:8080/${CDR(accountcode)})
exten => s,n,AudioSocket(${CDR(accountcode)},localhost:8080)
exten => s,n,Hangup()


exten => h,1,Set(endtime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => h,n,NoOp(${SIPCALLID})
exten => h,n,NoOp(${event_data})
exten => h,n,NoOp(${status_code})
exten => h,n,NooP(${CHANNEL(accountcode)} =${client_name}= ${UNIQUEID} =${CALLERID(num)}--${campaign}-${CALLERID(dnid)}-${CALLERID(name)})
exten => h,n,NoOp(${HANGUPCAUSE})
exten => h,n,NoOp(${CALLERID(dnid)})
exten => h,n,Set(CURLOPT(httptimeout)=1)
exten => h,n,Set(CURLOPT(conntimeout)=1)
exten => h,n,Set(foo=${CURL(http://localhost:8011/event,botstream=hangup&event_data=${event_data}&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${endtime})})
exten => h,n,NoOp(http://localhost:8011/event,botstream=hangup&event_data=NORMAL_CLEARING&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${endtime})
exten => h,n,NoOp(CURL-RESPONSE:${foo})
exten => h,n,Set(api_details=http://localhost:8011/event,botstream=hangup&event_data=${event_data}&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${endtime})
exten => h,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => h,n,MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => h,n,MYSQL(Query r ${connid} UPDATE port_details SET current_uses=(current_uses-1)  WHERE client_name='${client_name}')
exten => h,n,MYSQL(Disconnect ${connid})
exten => h,n,NoOp(http://localhost:8011/saveToAzure,uuid=${CHANNEL(accountcode)})
exten => h,n,Set(foo1=${CURL(http://localhost:8011/saveToAzure,uuid=${CHANNEL(accountcode)})})
exten => h,n,NoOp(CURL-RESPONSE:${foo1})
exten => h,n,Hangup()

[test_auto_call]
exten => pre_dial_handler,1,NooP(${CHANNEL(accountcode)}=${client_name}=${from_number}=${to_number}=${CALLERID(num)}-${campaign}-${UNIQUEID}-${CALLERID(dnid)}-${CALLERID(name)}=${phone})
exten => pre_dial_handler,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => pre_dial_handler,n,MYSQL(Query r ${connid} SELECT campaign,client_name FROM call_api WHERE uuid = '${CHANNEL(accountcode)}' and create_at >=curdate())
exten => pre_dial_handler,n,MYSQL(Fetch foundrow ${r} campaign_select client_name1)
exten => pre_dial_handler,n,MYSQL(Clear ${r})
exten => pre_dial_handler,n,NoOp(${campaign_select}-${client_name1})
exten => pre_dial_handler,n,MYSQL(Query r ${connid} UPDATE dstchannel SET dstchannel= '${CHANNEL}' WHERE uuid= '${CDR(accountcode)}' and date >= curdate())
exten => pre_dial_handler,n,MYSQL(Disconnect ${connid})
exten => pre_dial_handler,n,NoOp(${CHANNEL}== ${DSTCHANNEL})
exten => pre_dial_handler,n,Set(ringtime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => pre_dial_handler,n,Set(CURLOPT(httptimeout)=1)
exten => pre_dial_handler,n,Set(CURLOPT(conntimeout)=1)
exten => pre_dial_handler,n,Set(foo=${CURL(http://localhost:8011/event,botstream=ringing&uuid=${CHANNEL(accountcode)}&phone=${CALLERID(num)}&campaign=${campaign_select}&timestamp=${ringtime})})
exten => pre_dial_handler,n,NooP(http://localhost:8011/event,botstream=ringing&uuid=${CHANNEL(accountcode)}&phone=${CALLERID(num)}&campaign=${campaign_select}&timestamp=${ringtime})
exten => pre_dial_handler,n,NoOp(CURL-RESPONSE:${foo})
exten => pre_dial_handler,n,Set(api_details=http://localhost:8011/event,botstream=ringing&uuid=${CHANNEL(accountcode)}&phone=${CALLERID(num)}&campaign=${campaign_select}&timestamp=${ringtime})
exten => pre_dial_handler,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => pre_dial_handler,n,MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name1}','${foo}'))
exten => pre_dial_handler,n,MYSQL(Disconnect ${connid})
exten => pre_dial_handler,n,Return()

exten => _X.,1,NoOp()
exten => _X.,n,Set(CURLOPT(httptimeout)=1)
exten => _X.,n,Set(CURLOPT(conntimeout)=1)
exten => _X.,n,Set(phone=${EXTEN})
exten => _X.,n,Set(CALLERID(dnid)=${EXTEN})
exten => _x.,n,Set(CALLERID(rdnis)=${UNIQUEID})
exten => _X.,n,NooP(${CHANNEL(accountcode)}=${client_name}=${from_number}=${to_number}=${CALLERID(num)}-${campaign}-${UNIQUEID}-${CALLERID(dnid)}-${CALLERID(name)})
exten => _X.,n,Set(firsttime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => _X.,n,Set(foo=${CURL(http://localhost:8011/event,botstream=started&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${firsttime})})
exten => _X.,n,NooP(http://localhost:8011/event,botstream=started&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${firsttime})
exten => _X.,n,NoOp(CURL-RESPONSE:${foo})
exten => _X.,n,Set(api_details=http://localhost:8011/event,botstream=started&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${firsttime})
exten => _X.,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => _X.,n,MYSQL(Query r ${connid} INSERT INTO dstchannel (channel, uuid) VALUES ('${CHANNEL}','${CDR(accountcode)}'))
exten => _X.,n,MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => _X.,n,MYSQL(Query r ${connid} UPDATE port_details SET current_uses=current_uses+1  WHERE client_name= '${client_name}')
exten => _X.,n,MYSQL(Disconnect ${connid})


exten => _X.,n,NoOp()
exten => _X.,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => _X.,n,MYSQL(Query r ${connid} SELECT campaign,client_name FROM call_api WHERE uuid = '${CHANNEL(accountcode)}' and create_at >=curdate())
exten => _X.,n,MYSQL(Fetch foundrow ${r} campaign_select client_name1)
exten => _X.,n,MYSQL(Clear ${r})
exten => _X.,n,NoOp(${campaign_select}-${client_name1})
exten => _X.,n,MYSQL(Query r ${connid} UPDATE dstchannel SET dstchannel= '${CHANNEL}' WHERE uuid= '${CDR(accountcode)}' and date >= curdate())
exten => _X.,n,MYSQL(Disconnect ${connid})
exten => _X.,n,Set(ringtime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => _X.,n,Set(CURLOPT(httptimeout)=1)
exten => _X.,n,Set(CURLOPT(conntimeout)=1)
exten => _X.,n,Set(foo=${CURL(http://localhost:8011/event,botstream=ringing&uuid=${CHANNEL(accountcode)}&phone=${CALLERID(num)}&campaign=${campaign_select}&timestamp=${ringtime})})
exten => _X.,n,NooP(http://localhost:8011/event,botstream=ringing&uuid=${CHANNEL(accountcode)}&phone=${CALLERID(num)}&campaign=${campaign_select}&timestamp=${ringtime})
exten => _X.,n,NoOp(CURL-RESPONSE:${foo})
exten => _X.,n,Set(api_details=http://localhost:8011/event,botstream=ringing&uuid=${CHANNEL(accountcode)}&phone=${CALLERID(num)}&campaign=${campaign_select}&timestamp=${ringtime})
exten => _X.,n,MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => _X.,n,MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name1}','${foo}'))
exten => _X.,n,MYSQL(Disconnect ${connid})
exten => _X.,n,Wait(1)
exten => _X.,n,Answer()
exten => _X.,n,Wait(1)
exten => _X.,n,agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi,"Hello",en)
exten => _X.,n,Wait(11)
exten => _X.,n,agi(/var/lib/asterisk/agi-bin/asterisk-googletts/googletts.agi, "Yes i will clear my dues",en)
exten => _X.,n,Wait(20)
exten => _X.,n,Hangup()

;exten => _X.,n,Set(CALLERID(num)=0091${from_number})
;exten => _X.,n,Dial(PJSIP/0${phone}@tata-new,,b(pre_dial_handler^1)g)
;exten => _X.,n,NoOp(${DIALSTATUS})
;exten => _X.,n,NoOp(${HANGUPCAUSE})
;exten => _X.,n,NoOp(${SIP_CAUSE})
;exten => _X.,n,NoOp(${status_code})
;exten => _X.,n,NoOp(${event_data})
;exten => _X.,n,Goto(s-${DIALSTATUS},1)

exten => h,1,Noop($["${DIALSTATUS}" != "ANSWER"]?others:ans)
exten => h,n,NoOp(${DIALSTATUS})
exten => h,n,NoOp(${HANGUPCAUSE})
exten => h,n,Hangup()

exten => h,n(others),GotoIf($["${DIALSTATUS}" != "CANCEL"]?others1:hangup)
exten => h,n(others1),GotoIf($["${DIALSTATUS}" != "NOANSWER"]?others2:hangup)
exten => h,n(others2),GotoIf($["${DIALSTATUS}" != "BUSY"]?others3:hangup)
exten => h,n(others3),GotoIf($["${DIALSTATUS}" != "CONGESTION"]?others4:hangup)
exten => h,n(others4),GotoIf($["${DIALSTATUS}" != "CHANUNAVAIL"]?others5:hangup)
exten => h,n(others5),GotoIf($["${DIALSTATUS}" == ""]?others6:hangup)
exten => h,n(others6),Set(event_data=ServiceUnavailable)
exten => h,n(others6),Set(status_code=503)
exten => h,n(others6),NooP(${CHANNEL(accountcode)}=${client_name}= ${UNIQUEID} =${CALLERID(num)}--${campaign}-${CALLERID(dnid)}-${CALLERID(name)})
exten => h,n(others6),Set(endtime=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => h,n(others6),NoOp(${CALLERID(dnid)})
exten => h,n(others6),Set(CURLOPT(httptimeout)=1)
exten => h,n(others6),Set(CURLOPT(conntimeout)=1)
exten => h,n(others6),Set(foo=${CURL(http://localhost:8011/event,botstream=hangup&event_data=${event_data}&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${endtime})})
exten => h,n(others6),NoOp(http://localhost:8011/event,botstream=hangup&event_data=${event_data}=&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${endtime})
exten => h,n(others6),NoOp(CURL-RESPONSE:${foo})
exten => h,n(others6),Set(api_details=http://localhost:8011/event,botstream=hangup&event_data=${event_data}&status_code=${status_code}&uuid=${CHANNEL(accountcode)}&phone=${phone}&campaign=${campaign}&timestamp=${endtime})
exten => h,n(others6),MYSQL(Connect connid localhost asterisk Asterisk@#123 asterisk)
exten => h,n(others6),MYSQL(Query r ${connid} INSERT INTO api_access (api,uuid,client_name,api_response) VALUES ('${api_details}','${CDR(accountcode)}','${client_name}','${foo}'))
exten => h,n(others6),MYSQL(Query r ${connid} UPDATE port_details SET current_uses=(current_uses-1)  WHERE client_name='${client_name}')
exten => h,n(others6),MYSQL(Disconnect ${connid})
exten => h,n(others6),Hangup()
exten => h,n(ans),Hangup()
exten => h,n(hangup),NoOp(${DIALSTATUS})
exten => h,n(hangup),NoOp(${HANGUPCAUSE})
exten => h,n(hangup),Hangup()